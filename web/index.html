<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MiniGPT</title>
</head>

<body style="margin:0; padding:16px; font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb;">
  <div id="top"></div>

  <div id="chat" style="height:60vh; overflow:auto; border:1px solid #334155; padding:12px; background:#111827;"></div>

  <div style="display:flex; gap:8px; margin-top:10px;">
    <input id="msg" style="flex:1; padding:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb;"
           placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
    <button id="send" style="padding:10px 16px; border:1px solid #334155; background:#111827; color:#e5e7eb;">
      Send
    </button>
  </div>

  <!-- Telegram WebApp API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    (function () {
      function banner(html, bg, border) {
        var top = document.getElementById("top");
        var div = document.createElement("div");
        div.style.padding = "10px";
        div.style.marginBottom = "8px";
        div.style.background = bg;
        div.style.border = "1px solid " + border;
        div.innerHTML = html;
        top.insertBefore(div, top.firstChild);
      }

      function line(who, text) {
        var chat = document.getElementById("chat");
        var p = document.createElement("p");
        p.style.margin = "6px 0";
        p.textContent = who + ": " + text;
        chat.appendChild(p);
        chat.scrollTop = chat.scrollHeight;
      }

      // –ª–æ–≤–∏–º –ª—é–±—ã–µ –æ—à–∏–±–∫–∏ JS –ø—Ä—è–º–æ –Ω–∞ —ç–∫—Ä–∞–Ω
      window.onerror = function (msg, src, lineNo, colNo) {
        banner("JS ERROR ‚ùå<br>" + String(msg) + "<br>" + String(src  "") + ":" + (lineNo"") + ":" + (colNo||""),
               "#3f1d1d", "#ef4444");
      };

      banner("INDEX INLINE JS START ‚úÖ", "#12301b", "#22c55e");

      var input = document.getElementById("msg");
      var send  = document.getElementById("send");

      if (!input  !send) {
        banner("DOM ERROR ‚ùå –Ω–µ—Ç #msg –∏–ª–∏ #send", "#3f1d1d", "#ef4444");
        return;
      }

      // Telegram WebApp
      var tg = null;
      if (window.Telegram && window.Telegram.WebApp) {
        tg = window.Telegram.WebApp;
        try {
          tg.ready();
          tg.expand();
          line("system", "Telegram WebApp –Ω–∞–π–¥–µ–Ω ‚úÖ");
        } catch (e) {
          line("system", "Telegram WebApp –µ—Å—Ç—å, –Ω–æ –æ—à–∏–±–∫–∞: " + e.message);
        }
      } else {
        line("system", "–û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram (–≤ –±—Ä–∞—É–∑–µ—Ä–µ —ç—Ç–æ –æ–∫).");
      }

      // Backend
      var BACKEND_URL = "https://tg-mini-gpt.onrender.com";

      function setEnabled(v) {
        send.disabled = !v;
        input.disabled = !v;
        send.style.opacity = v ? "1" : "0.6";
      }

      // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –∑–∞–ø—Ä–æ—Å: XMLHttpRequest (–±–µ–∑ fetch/async)
      function postChat(text, cbOk, cbErr) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", BACKEND_URL + "/chat", true);
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = function () {
          if (xhr.readyState !== 4) return;

          var body = null;
          try { body = JSON.parse(xhr.responseText); } catch (e) {}

          if (xhr.status >= 200 && xhr.status < 300) {
            cbOk(body && body.answer ? body.answer : "");
          } else {
            var msg = (body && body.detail) ? body.detail : ("HTTP " + xhr.status);
            cbErr(msg);
          }
        };

        var initData = tg ? (tg.initData  "") : "";
        xhr.send(JSON.stringify({ initData: initData, text: text }));
      }

      function onSend() {
        var text = (input.value || "").trim();
        if (!text) return;

        line("you", text);
        input.value = "";
        setEnabled(false);

        postChat(
          text,
          function (answer) {
            line("gpt", answer);
            setEnabled(true);
            input.focus();
          },
          function (err) {
            line("system", "–û—à–∏–±–∫–∞: " + err);
            setEnabled(true);
            input.focus();
          }
        );
      }

      // Telegram WebView: click + touchend
      send.addEventListener("click", onSend);
      send.addEventListener("touchend", function (e) { e.preventDefault(); onSend(); });

      // Enter
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") onSend();
      });

      line("system", "–ì–æ—Ç–æ–≤–æ. –ü–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ üëá");
    })();
  </script>
</body>
</html>